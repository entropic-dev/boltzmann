name: Release Boltzmann CLI
on:
  release:
    types: [published, edited]
jobs:
  docs:
    name: publish docs
    runs-on: ubuntu-latest
    steps:
      - name: download docs
        run: |
          tag=${{ github.ref }}
          download_url=$(
            curl -sL https://api.github.com/repos/entropic-dev/boltzmann/releases/tags/${tag/refs\/tags\//} | \
              jq -r '.assets[] | .browser_download_url' | \
              grep 'docs'
          )
          mkdir docs
          curl -sL $download_url | tar zx -C docs
          cd docs
          aws s3 cp --recursive . s3://www.boltzmann.dev/en/docs/${tag/refs\/tags\//} --acl public-read
          cd ..
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2

  release:
    name: publish npm package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '12'
      - name: download release contents
        run: |
          tag=${{ github.ref }}
          download_urls=$(
            curl -sL https://api.github.com/repos/entropic-dev/boltzmann/releases/tags/${tag/refs\/tags\//} | \
              jq -r '.assets[] | .browser_download_url' | \
              grep -v 'docs'
          )

          mkdir -p boltzmann-cli
          for url in $download_urls; do
            curl -sL $url | tar zx
            name=$(basename $url)
            mv boltzmann boltzmann-cli/${name/.tar.gz/}
          done

          # you're killing me, buster
          mv boltzmann-cli/boltzmann_x64_win32{,.exe}

      - name: create npm package
        run: |
          cd boltzmann-cli
          npm init -y
          cd ..
          tag=${{ github.ref }}
          jq -rM '.description = "The boltzmann CLI" |
                 .bin = "./index.js" |
                 .scripts.test = "echo ok" |
                 .author = "Static T. Raccoon <static-t-raccoon@example.com> (https://entropic-dev.github.io/boltzmann)" |
                 .keywords = ["boltzmann", "scaffold http"] |
                 .license = "Apache-2.0" |
                 .version = "'"${tag/refs\/tags\//}"'"' < boltzmann-cli/package.json > package.json

          mv package.json boltzmann-cli/package.json
          cat boltzmann-cli/package.json

          cat > boltzmann-cli/index.js <<-EOF
          #!/usr/bin/env node
          'use strict'
          const os = require('os')
          const path = require('path')
          const fs = require('fs')
          const spawnSync = require('child_process').spawnSync

          const executable = path.join(__dirname, 'boltzmann_' + os.arch() + '_' + os.platform()) + (os.platform() === 'win32' ? '.exe' : '')

          if (!fs.existsSync(executable)) {
            console.error("Sorry, boltzmann is not yet supported on %s", os.platform())
            console.error()
            console.error("Open an issue here: https://github.com/entropic-dev/boltzmann/issues/new?title=%s+support", os.platform())
            process.exit(1)
          }

          spawnSync(executable, process.argv.slice(2), { stdio: 'inherit' })
          EOF

          cat > ~/.npmrc <<-EOF
          registry=https://registry.npmjs.org/
          //registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}
          EOF

          cp README.md boltzmann-cli/

          cd boltzmann-cli
          npm publish
          pkg=$(cat package.json)
          echo "$pkg" | jq -rM '.name = "create-boltzmann"' > package.json
          npm publish
