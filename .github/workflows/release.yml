name: Release Boltzmann
on:
  release:
    types: [published]
jobs:
  release:
    name: publish npm package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v1
        with:
          node-version: '12'
      - name: download release contents
        run: |
          download_urls = $(
            curl -sL https://api.github.com/repos/entropic-dev/boltzmann/releases/tags/${{ github.ref }} | \
              jq -r '.assets[] | .browser_download_url' \
              grep -v 'docs'
          )

          mkdir -p boltzmann-cli
          for url in download_urls; do
            curl -sL $url | tar zxfv -C boltzmann-cli
            name=$(basename $url)
            mv boltzmann-cli/boltzmann boltzmann-cli/boltzmann_${name/tar.gz/}
          done

      - name: create npm package
        run: |
          npm init -y boltzmann-cli
          jq -rM '.description = "The boltzmann CLI" |' \
                 '.scripts.test = "echo ok" |' \
                 '.author = "Static T. Raccoon <static-t-raccoon@example.com> (https://entropic-dev.github.io/boltzmann)" |' \
                 '.keywords = ["boltzmann", "scaffold http"] |' \
                 '.license = "Apache-2.0"' \
                 '.version = "${{ github.ref }}"' < boltzmann-cli/package.json > boltzmann-cli/package.json

          cat > boltzmann-cli/index.js <<-EOF
            'use strict'
            const os = require('os')
            const path = require('path')
            const fs = require('fs')
            const spawnSync = require('child_process').spawnSync

            const executable = path.join(__dirname, `boltzmann_\${os.arch()}_\${os.platform()`)

            if (!fs.existsSync(executable)) {
              console.error("Sorry, boltzmann is not yet supported on %s", os.platform())
              process.exit(1)
            }

            spawnSync(executable, process.argv.slice(2))
          EOF

          cat > .npmrc <<-EOF
          registry=https://registry.npmjs.org/
          //registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}
          EOF
          cd boltzmann-cli
          npm publish
